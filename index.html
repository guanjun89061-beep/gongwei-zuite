<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å·¥ä½å˜´æ›¿ Â· è¯­éŸ³åæ§½æ­å­</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .card {
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      max-width: 720px;
      width: 100%;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    .sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    label {
      font-size: 14px;
      margin-bottom: 6px;
      display: block;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }
    select, button, input[type="text"] {
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .row > div {
      flex: 1;
    }
    .btn-main {
      background: #ef4444;
      color: #ffffff;
      font-weight: 600;
      border: none;
      cursor: pointer;
      padding: 10px 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-right: 8px;
    }
    .btn-main:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-mic {
      background: #0ea5e9;
      color: #ffffff;
      font-weight: 500;
      border: none;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-mic.listening {
      background: #22c55e;
    }
    .status {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
      min-height: 18px;
    }
    .output {
      margin-top: 18px;
      padding: 12px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>å·¥ä½å˜´æ›¿ Â· è¯­éŸ³åæ§½æ­å­</h1>
    <div class="sub">æŒ‰ä½éº¦å…‹é£åæ§½ï¼Œç‚¹æŒ‰é’®è®© AI å¸®ä½ éª‚å›æ¥ï¼Œè¿˜ä¼šå¿µå‡ºæ¥ç»™ä½ å¬ã€‚</div>

    <label for="scenario">ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ˆå¯ä»¥è‡ªå·±æ‰“å­—ï¼Œä¹Ÿå¯ä»¥ç”¨è¯­éŸ³ï¼‰</label>
    <textarea id="scenario" placeholder="ä¾‹å¦‚ï¼šå‘¨äº”æ™šä¸Š 9 ç‚¹ï¼Œé¢†å¯¼çªç„¶è¯´æ–¹æ¡ˆä¸é«˜çº§ï¼Œè¦æˆ‘é‡åšï¼Œè¿˜æš—ç¤ºä»Šæ™šæœ€å¥½èƒ½æ”¹å®Œã€‚"></textarea>

    <div class="row">
      <div>
        <label for="target">ä½ æƒ³éª‚è°ï¼Ÿï¼ˆè€æ¿ / é¢†å¯¼ / ç”²æ–¹ / åŒäº‹â€¦ï¼‰</label>
        <input id="target" type="text" placeholder="ä¾‹å¦‚ï¼šé¢†å¯¼ã€ç”²æ–¹ã€ç‹—è€æ¿">
      </div>
      <div>
        <label for="style">é£æ ¼</label>
        <select id="style">
          <option value="rant">å‘ç–¯åæ§½é£</option>
          <option value="reply">é«˜æƒ…å•†å›æ€¼é£</option>
          <option value="resign">è¾èŒå¹»æƒ³é£</option>
        </select>
      </div>
    </div>

    <div style="margin-top: 8px;">
      <button class="btn-main" id="btnSend">ğŸ’£ å¸®æˆ‘éª‚ä¸€éª‚</button>
      <button class="btn-mic" id="btnMic">ğŸ™ æŒ‰ä¸€ä¸‹å¼€å§‹è¯´</button>
    </div>

    <div class="status" id="status"></div>

    <div class="output" id="output" style="display:none;"></div>
  </div>

  <script>
    const btnSend = document.getElementById("btnSend");
    const btnMic = document.getElementById("btnMic");
    const statusEl = document.getElementById("status");
    const outputEl = document.getElementById("output");
    const scenarioEl = document.getElementById("scenario");

    // ======== è¯­éŸ³è½¬æ–‡å­—ï¼ˆè¯­éŸ³è¾“å…¥ï¼‰ ========
    let recognition = null;
    let listening = false;

    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        console.warn("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ SpeechRecognition");
        statusEl.textContent = "å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼Œå¯ä»¥å…ˆç”¨æ–‡å­—åæ§½ï½";
        btnMic.disabled = true;
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = "zh-CN";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        listening = true;
        btnMic.classList.add("listening");
        btnMic.textContent = "ğŸ™ æ­£åœ¨å¬ä½ åæ§½â€¦";
        statusEl.textContent = "å¼€å§‹å½•éŸ³äº†ï¼Œå°½æƒ…éª‚ã€‚è¯´å®Œåœä¸€ä¸‹æˆ‘ä¼šè‡ªåŠ¨è¯†åˆ«ã€‚";
      };

      recognition.onend = () => {
        listening = false;
        btnMic.classList.remove("listening");
        btnMic.textContent = "ğŸ™ å†è¯´ä¸€æ®µ";
        if (!scenarioEl.value.trim()) {
          statusEl.textContent = "æ²¡å¬åˆ°å†…å®¹æˆ–è€…æ—¶é—´å¤ªçŸ­ï¼Œå¯ä»¥å†è¯•ä¸€æ¬¡ã€‚";
        } else {
          statusEl.textContent = "è¯­éŸ³å·²è½¬æˆæ–‡å­—ï¼Œä½ å¯ä»¥ç‚¹ã€Œå¸®æˆ‘éª‚ä¸€éª‚ã€ã€‚";
        }
      };

      recognition.onerror = (event) => {
        listening = false;
        btnMic.classList.remove("listening");
        btnMic.textContent = "ğŸ™ å†è¯´ä¸€æ®µ";
        console.error(event);
        statusEl.textContent = "è¯­éŸ³è¯†åˆ«å‡ºé”™äº†ï¼Œå¯ä»¥å†è¯•ä¸€æ¬¡ï¼Œæˆ–è€…æ”¹ç”¨æ–‡å­—è¾“å…¥ã€‚";
      };

      recognition.onresult = (event) => {
        const result = event.results[0][0].transcript;
        // è¿½åŠ åˆ°æ–‡æœ¬æ¡†é‡Œï¼Œæ–¹ä¾¿ç”¨æˆ·ç»§ç»­æ‰‹åŠ¨ä¿®æ”¹
        if (scenarioEl.value.trim()) {
          scenarioEl.value = scenarioEl.value.trim() + "\n" + result;
        } else {
          scenarioEl.value = result;
        }
      };
    }

    btnMic.addEventListener("click", () => {
      if (!recognition) {
        initSpeechRecognition();
        if (!recognition) return;
      }
      if (!listening) {
        recognition.start();
      } else {
        recognition.stop();
      }
    });

    // ======== è°ƒç”¨åç«¯ + æ–‡å­—è½¬è¯­éŸ³ï¼ˆAI å›å¤è¯­éŸ³ï¼‰ ========
    async function sendRant() {
      const scenario = scenarioEl.value.trim();
      const target = document.getElementById("target").value.trim() || "å¯¹æ–¹";
      const style = document.getElementById("style").value;

      if (!scenario) {
        alert("å…ˆæŠŠä»Šå¤©çš„ç ´äº‹è¯´ä¸€è¯´ / å†™ä¸€å†™å§ï½");
        return;
      }

      btnSend.disabled = true;
      statusEl.textContent = "æ­£åœ¨ç»„ç»‡è¯­è¨€å¸®ä½ éª‚äººä¸­â€¦â€¦";
      outputEl.style.display = "none";
      outputEl.textContent = "";

      try {
        const resp = await fetch("/api/rant", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            scenario,
            target,
            style,
            language: "zh"
          })
        });

        const data = await resp.json();

        if (!resp.ok || !data.success) {
          console.error(data);
          statusEl.textContent = "å“å‘€ï¼Œéª‚åˆ°ä¸€åŠå¡å£³äº†â€¦â€¦å¯ä»¥å†è¯•ä¸€æ¬¡ã€‚";
        } else {
          const reply = data.data.reply;
          statusEl.textContent = "å¥½äº†ï¼ä¸‹é¢è¿™æ®µæ˜¯ä½ çš„ä¸“å±å˜´æ›¿è¾“å‡ºï¼š";
          outputEl.style.display = "block";
          outputEl.textContent = reply;

          // === æµè§ˆå™¨æœ—è¯»ï¼ˆTTSï¼‰ ===
          if ("speechSynthesis" in window) {
            const utter = new SpeechSynthesisUtterance(reply);
            utter.lang = "zh-CN";
            utter.rate = 1.0;   // è¯­é€Ÿ
            utter.pitch = 1.0;  // éŸ³è°ƒ
            window.speechSynthesis.cancel(); // å…ˆåœæ‰ä¹‹å‰çš„
            window.speechSynthesis.speak(utter);
          } else {
            console.warn("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ speechSynthesis");
          }
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "ç½‘ç»œå¥½åƒå‡ºé—®é¢˜äº†ï¼Œæ£€æŸ¥ä¸€ä¸‹åç«¯æ˜¯ä¸æ˜¯è¿˜å¼€ç€ã€‚";
      } finally {
        btnSend.disabled = false;
      }
    }

    btnSend.addEventListener("click", sendRant);
  </script>
</body>
</html>
